<%- include("navbar.ejs")%>
<div id="content">
    <div class="row justify-content-center">
        <div class="col-lg-12 col-md-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Product List</h5>
                    <a href="/admin/add_product" class="btn btn-light btn-sm">Add New Product</a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle table-bordered" id="productTable">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th class="text-center">Actions</th>
                                    <th>Image</th>
                                    <th>Name</th>
                                    <th>Brand</th>
                                    <th>Style</th>
                                    <th>Type</th>
                                    <th>For</th>
                                    <th>Kid Type</th>
                                    <th>Stock</th>
                                    <th>Color</th>
                                    <th>Market Price</th>
                                    <th>Selling Price</th>
                                    <th>Discount %</th>
                                    <th>Trending</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% for(var i=0;i<result.length;i++){ %>
                                    <tr>
                                        <td><%= i+1 %></td>
                                        <td class="text-center">
                                            <button class="btn btn-outline-primary btn-sm mb-1 editBtn"
                                                    data-id="<%= result[i].product_id %>"
                                                    data-name="<%= result[i].product_name %>"
                                                    data-market_price="<%= result[i].product_market_price %>"
                                                    data-selling_price="<%= result[i].product_price %>"
                                                    data-discount_percent="<%= result[i].apply_discount_percent %>"
                                                    data-is_trending="<%= result[i].product_is_trending %>"
                                                    data-brand_id="<%= result[i].product_brand_id %>"
                                                    data-style_id="<%= result[i].product_style_id %>"
                                                    data-type_id="<%= result[i].product_type_id %>"
                                                    data-for="<%= result[i].product_for %>"
                                                    data-kid_type="<%= result[i].product_kid_type %>"
                                                    data-stock="<%= result[i].product_stock %>"
                                                    data-color="<%= result[i].product_color %>"
                                                    data-main_image="<%= result[i].product_main_image %>"
                                                    data-images="<%= result[i].product_images %>"
                                                    data-description="<%= result[i].product_description %>"
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#myModal"
                                                    title="Edit">
                                                <i class="bi bi-pencil"></i> Edit
                                            </button>
                                            <a href="/admin/delete_product/<%= result[i].product_id %>" class="btn btn-outline-danger btn-sm mb-1" title="Delete" onclick="return confirm('Are you sure you want to delete this product?');">
                                                <i class="bi bi-trash"></i> Delete
                                            </a>
                                        </td>
                                        <td>
                                            <img src="/products/<%= result[i].product_main_image %>" alt="Product Image" class="img-thumbnail" style="width: 70px; height: 70px; object-fit: cover;">
                                        </td>
                                        <td><strong><%= result[i].product_name %></strong></td>
                                        <td><%= result[i].product_brand_name %></td>
                                        <td><%= result[i].product_style_name %></td>
                                        <td><%= result[i].product_type_name %></td>
                                        <td><%= result[i].product_for %></td>
                                        <td><%= result[i].product_kid_type ? result[i].product_kid_type : '-' %></td>
                                        <td><span class="badge bg-info text-dark"><%= result[i].product_stock %></span></td>
                                        <td><%= result[i].product_color %></td>
                                        <td>₹<%= result[i].product_market_price %></td>
                                        <td>₹<%= result[i].product_price %></td>
                                        <td>
                                            <% 
                                                var discount = result[i].apply_discount_percent;
                                                if (discount !== undefined && discount !== null) {
                                                    discount = Number(discount).toFixed(2);
                                                } else {
                                                    discount = "-";
                                                }
                                            %>
                                            <%= discount %>%
                                        </td>
                                        <td>
                                            <% if(result[i].product_is_trending == "yes" || result[i].product_is_trending === "Yes"){ %>
                                                <span class="badge bg-success">Yes</span>
                                            <% } else { %>
                                                <span class="badge bg-secondary">No</span>
                                            <% } %>
                                        </td>
                                        <td style="max-width: 200px; white-space: pre-line; overflow: hidden; text-overflow: ellipsis;">
                                            <%= result[i].product_description.length > 100 ? result[i].product_description.substring(0, 100) + '...' : result[i].product_description %>
                                        </td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade ms-5" id="myModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <!-- Modal Header -->
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalLabel">Update Product</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <!-- Modal Body -->
                    <form class="m-2" action="/admin/update_product" method="post" enctype="multipart/form-data" id="productForm">
                        <!-- Hidden ID -->
                        <input type="hidden" name="product_id" id="edit_product_id">

                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="product_name" class="form-label">Product Name</label>
                                <input type="text" class="form-control" id="product_name" name="product_name">
                            </div>
                            <div class="col-md-2">
                                <label for="market_price" class="form-label">Market Price</label>
                                <input type="number" step="0.01" class="form-control" id="market_price" name="product_market_price" min="0">
                            </div>
                            <div class="col-md-2">
                                <label for="selling_price" class="form-label">Selling Price</label>
                                <input type="number" step="0.01" class="form-control" id="selling_price" name="product_price" min="0">
                            </div>
                            <div class="col-md-4">
                                <label for="product_image" class="form-label">Main Image</label>
                                <input type="file" class="form-control" name="product_main_image">
                                <input type="hidden" id="product_image" name="product_main_image">
                            </div>
                            <div class="col-md-3">
                                <label for="is_trending" class="form-label">Is Trending?</label>
                                <select class="form-select" id="is_trending" name="product_is_trending">
                                    <option value="yes">Yes</option>
                                    <option value="no" selected>No</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="product_brand" class="form-label">Product Brand</label>
                                <select class="form-select" id="product_brand" name="product_brand_id">
                                    <option value="">Select Brand</option>
                                    <% for(var i=0;i<brands.length;i++){ %>
                                        <option value="<%= brands[i].product_brand_id %>"><%= brands[i].product_brand_name %></option>
                                    <% } %>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="product_style" class="form-label">Product Style</label>
                                <select class="form-select" id="product_style" name="product_style_id">
                                    <option value="">Select Style</option>
                                    <% for(var i=0;i<styles.length;i++){ %>
                                        <option value="<%= styles[i].product_style_id %>"><%= styles[i].product_style_name %></option>
                                    <% } %>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="product_type" class="form-label">Product Type</label>
                                <select class="form-select" id="product_type" name="product_type_id">
                                    <% for(var i = 0; i < types.length; i++) { %>
                                        <option value="<%= types[i].product_type_id %>">
                                            <%= types[i].product_type_name %>
                                        </option>
                                    <% } %>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="product_for" class="form-label">Product For</label>
                                <select class="form-select" id="product_for" name="product_for">
                                    <option value="">Select For</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Kids">Kids</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="kid_type" class="form-label">Kid Type</label>
                                <select class="form-select" id="kid_type" name="product_kid_type">
                                    <option value="">Select Kid Type</option>
                                    <option value="Both">Both</option>
                                    <option value="Boys">Boys</option>
                                    <option value="Girls">Girls</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="stock" class="form-label">Available Stock</label>
                                <input type="number" class="form-control" id="stock" name="product_stock" min="0">
                            </div>
                            <div class="col-md-3">
                                <label for="product_color" class="form-label">Product Color</label>
                                <input type="text" class="form-control" id="product_color" name="product_color">
                            </div>
                            <div class="col-md-12">
                                <label for="product_description" class="form-label">Product Description  <span class="text-warning small fw-light mb-2">(Update description only if changes are needed)</span></label>
                                <textarea class="form-control" id="editor" name="product_description" rows="4"></textarea>
                                <textarea hidden class="form-control col-12" name="product_description2" id="product_description" rows="2" readonly></textarea>
                            </div>
                        </div>
                    </form>

                    <!-- Modal Footer -->
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="saveChangesBtn">Save changes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<%- include("footer.ejs")%>

<script>
    // Function to show/hide kid type based on product_for selection
    function toggleKidType() {
        const productFor = document.getElementById('product_for');
        const kidTypeSelect = document.getElementById('kid_type');
        
        if (productFor.value === 'Kids') {
            kidTypeSelect.disabled = false;
            kidTypeSelect.required = true;
        } else {
            kidTypeSelect.disabled = true;
            kidTypeSelect.required = false;
            kidTypeSelect.value = '';
        }
    }

    // Initialize event listeners when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Set up product_for change listener
        document.getElementById('product_for').addEventListener('change', toggleKidType);
        
        // Edit button click handler
        document.querySelectorAll(".editBtn").forEach(button => {
            button.addEventListener("click", function() {
                const id = this.getAttribute("data-id");
                const name = this.getAttribute("data-name");
                const market_price = this.getAttribute("data-market_price");
                const selling_price = this.getAttribute("data-selling_price");
                const is_trending = this.getAttribute("data-is_trending");
                const description = this.getAttribute("data-description");
                const brand_id = this.getAttribute("data-brand_id");
                const style_id = this.getAttribute("data-style_id");
                const type_id = this.getAttribute("data-type_id");
                const for_type = this.getAttribute("data-for");
                const kid_type = this.getAttribute("data-kid_type");
                const stock = this.getAttribute("data-stock");
                const color = this.getAttribute("data-color");
                const main_image = this.getAttribute("data-main_image");

                document.getElementById("edit_product_id").value = id;
                document.getElementById("product_name").value = name;
                document.getElementById("market_price").value = market_price;
                document.getElementById("selling_price").value = selling_price;
                document.getElementById("is_trending").value = is_trending;
                document.getElementById("product_description").value = description;
                document.getElementById("product_brand").value = brand_id;
                document.getElementById("product_style").value = style_id;
                document.getElementById("product_type").value = type_id;
                document.getElementById("product_for").value = for_type;
                document.getElementById("kid_type").value = kid_type;
                document.getElementById("stock").value = stock;
                document.getElementById("product_color").value = color;
                document.getElementById("product_image").value = main_image;

                // Trigger the kid type toggle
                toggleKidType();
            });
        });
        
        // Save button click handler
        var saveBtn = document.getElementById("saveChangesBtn");
        if (saveBtn) {
            saveBtn.addEventListener("click", function(e) {
                const form = document.getElementById("productForm");
                if (form) {
                    if (form.checkValidity()) {
                        form.submit();
                    } else {
                        form.reportValidity();
                    }
                }
            });
        }
    });
</script>